@page "/AnagraficaR"
@using MySqlConnector;
<PageTitle>Anagrafica</PageTitle>
@rendermode InteractiveServer

<div class="container-fluid mt-5 mt-sm-0">
    <!--top bar-->
    <div class="container-fluid">
        <!--pages: questa sezione deve dividersi in 2 siccome i pulsanti occupano solo metà dello spazio del container genitore-->
        <div class="row pages">
            <!--suddivido la riga in 2 colonne-->
            <div class="col-md-8 col-sm-12">
                <!--suddivido la colonna in 4, uno per ogni pulsante-->
                <div class="row">
                    <div class="col ps-1 pe-0  px-md-1 pl-sm-0 pr-sm-1">
                        <button class="scheda selectedPage" id="btnPaziente">
                            pazienti
                        </button>
                    </div>

                    <div class="col p-0 px-md-1 pl-sm-0 pr-sm-1">
                        <button class="scheda unselectedPage" id="btnClienti">
                            clienti
                        </button>
                    </div>

                    <div class="col p-0 px-md-1 pl-sm-0 pr-sm-1">
                        <button class="scheda unselectedPage" id="btnFornitori">
                            fornitori
                        </button>
                    </div>

                    <div class="col p-0 px-md-1 pl-sm-0 pr-sm-1">
                        <button class="scheda unselectedPage" id="btnContatti">
                            contatti
                        </button>
                    </div>
                </div>
            </div>
            <!--questa colonna resterà vuota per spaziare e eventualemte rimossa per dispositivi mobili-->
            <div class="col hidden-sm">

            </div>
        </div>
        <!--buttons-->
        <div class="row toolbar">
            <!-- suddivisione in 2-2-2-1-3-1-1 della barra-->
            <div class="col-3 col-sm-2 col-md-2 ps-1 pe-0  px-md-1 pl-sm-0 pr-sm-1">
                <button class="btnTool" @onclick="toggleForm" id="btnAggiungi" data-toggle="modal" data-target="#exampleModalCenter">
                    Aggiungi
                </button>
            </div>

            <div class="col-3 col-sm-2 col-md-2 p-0 px-md-1 pl-sm-0 pr-sm-1">
                <button class="btnTool" id="btnModifica">
                    Modifica
                </button>
            </div>

            <div class="col-3 col-sm-2 col-md-2 p-0 px-md-1 pl-sm-0 pr-sm-1">
                <button class="btnTool" id="btnElimina">
                    elimina
                </button>
            </div>

            <div class="d-none d-sm-flex col-sm-1 p-0 px-md-1 pl-sm-0 pr-sm-1">
                <button class="btnTool" id="btnStampa">
                    Stampa
                </button>
            </div>

            <div class="col-3 col-sm-2 col-md-3 p-0 px-md-1 pl-sm-0 pr-sm-1">
                <input class="inputRicerca" id="txtRicerca" placeholder="Ricerca"/> <!--@bind-value="searchValue" @oninput="searchPatient"-->
            </div>

            <div class="d-none d-sm-flex col-sm-1 p-0 px-md-1 pl-sm-0 pr-sm-1">
                <div class="col sideNum">
                    N
                </div>
                <div class="col">
                    <input class="inNum" id="inputCartella" type="number" placeholder="0"/>
                </div>
            </div>

            <div class="d-none d-sm-flex col-sm-1 p-0 px-md-1 pl-sm-0 pr-sm-1">
                <div class="col sideNum">
                    P
                </div>
                <div class="col">
                    <input class="inNum" id="inputPagina" type="number" placeholder="0"/>
                </div>
            </div>
        </div>
    </div>

    <!-- corpo centrale della pagina -->

    <div class="container-fluid corpo mt-1">
        <!-- heading della tabella -->
        <div class="row heading">
            <!-- divisione in 2-1-1-1-1-1-1-1-1-1-1-->
            <div class="col-3 col-sm-2 cella">
                cognome
            </div>
            <div class="col-2 col-sm-1 cella">
                nome
            </div>
            <div class="col-2 col-sm-1 cella">
                nascita
            </div>
            <div class="col-2 col-sm-1 cella">
                età
            </div>
            <div class="col-2 col-sm-1 cella">
                telefono
            </div>
            <div class=" d-none d-sm-block col-1 cella">
                telefono2
            </div>
            <div class=" d-none d-sm-block col-1 cella">
                fatturare
            </div>
            <div class=" d-none d-sm-block col-1 cella">
                terminato
            </div>
            <div class="d-none d-sm-block col-1 cella">
                documentato
            </div>
            <div class="d-none d-sm-block col-1 cella lock">

            </div>
            <div class="col-1 cella">

            </div>
        </div>
        <!-- body della tabella-->
        <div class>
            <div class="row rigo mt-1">
                <!-- divisione in 2-1-1-1-1-1-1-1-1-1-1-->
                <div class="col-3 col-sm-2 cella">
                    cognome
                </div>
                <div class="col-2 col-sm-1 cella">
                    nome
                </div>
                <div class="col-2 col-sm-1 cella">
                    nascita
                </div>
                <div class="col-2 col-sm-1 cella">
                    età
                </div>
                <div class="col-2 col-sm-1 cella">
                    telefono
                </div>
                <div class=" d-none d-sm-block col-1 cella">
                    telefono2
                </div>
                <div class=" d-none d-sm-block col-1 cella">
                    fatturare
                </div>
                <div class=" d-none d-sm-block col-1 cella">
                    terminato
                </div>
                <div class="d-none d-sm-block col-1 cella">
                    documentato
                </div>
                <div class="col-1 cella">
                    <input type="checkbox"/>
                </div>

                <div class="col-1 cella">

                </div>

            </div>

        </div>
    </div>
</div>

@if (visible)
{
    <!--div utilizzato per oscurare la pagina mentre il pop up viene aperto-->
    <div class="oscuramento justify-content-center">
    <!--contenitore popup-->
    <div class="containerForm popUp px-4">
    <!--parte superiore-->
    <div class="row">
        <!--barra pulsanti-->
        <div class="col-9 col-sm-11 barra">
            <div class="row">
                <div class="col-6 col-sm-3">
                    <button class="btnForm selectedPage">Dati personai</button>
                </div>
                <div class="col-6 col-sm-3">
                    <button class="btnForm unselectedPage">familiari</button>
                </div>
                <div class="col-6 col-sm-3">
                    <button class="btnForm unselectedPage">contatti -fatturazione</button>
                </div>
                <div class="col-6 col-sm-3">
                    <button class="btnForm unselectedPage">note</button>
                </div>
            </div>
        </div>
        <!--barra pulsanti-->
        <div class="col-1">
            <button class="exit">
                X
            </button>
        </div>
    </div>
    <!--corpo centrale-->
    <div class="row mt-1 mt-sm-2">
        <!--parte inserimento dati-->
        <div class="formbody col-8 col-sm-10">
            <div class="row">
                <div class="row">
                    <!--prima riga-->
                    <div class="col-12 col-sm-6">
                        <div class="cardInput">
                            <div class="row">
                                cognome*
                            </div>
                            <div class="row">
                                <input class="inputForm" type="text"/>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6">
                        <div class="cardInput">
                            <div class="row">
                                Nome*
                            </div>
                            <div class="row">
                                <input class="inputForm" type="text"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!--seconda riga-->
                <div class="row mt-1">
                    <div class="col-12 col-sm-6">
                        <div class="cardInput">
                            <div class="row">
                                <div class="ps-0 col-6 justify-content-start">luogo nascita</div>
                                <div class="col-6 align-content-center">
                                    <label for="isEstero" style="font-size: 0.6rem">estero</label>
                                    <input type="checkbox" id="isEstero"/>
                                </div>
                            </div>
                            <div class="row">
                                <input class="inputForm" type="text"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <div class="row">
                            <div class="col">
                                <div class="SmallcardInput">
                                    <div class="row">
                                        provincia
                                    </div>
                                    <div class="row">
                                        <input class="inputForm" type="text"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="SmallcardInput">
                                    <div class="row">
                                        sesso
                                    </div>
                                    <div class="row">
                                        <select type="select" class="inputForm" placeholder=" ">
                                            <!--@bind="gender"-->
                                            <option value="m">Maschio</option>
                                            <option value="f">Femmina</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--terza riga-->
                <div class="row mt-1">
                    <div class="col-12 col-sm-6">
                        <div class="row">
                            <div class="col">
                                <div class="SmallcardInput">
                                    <div class="row">
                                        data nascita
                                    </div>
                                    <div class="row">
                                        <input class="inputForm data" type="date"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="SmallcardInput">
                                    <div class="row">
                                        codice asl
                                    </div>
                                    <div class="row">
                                        <input class="inputForm" type="text"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <div class="cardInput">
                            <div class="row">
                                <div class="ps-0 col-6 justify-content-start">codice fiscale</div>
                                <div class="col-6 align-content-center">
                                    <label for="isEstero" style="font-size: 0.6rem">controllo validità</label>
                                    <input type="checkbox" id="isEstero"/>
                                </div>
                            </div>
                            <div class="row">
                                <input class="inputForm" type="text"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!--quarta riga-->
                <div class="row mt-1">
                    <div class="col-12 col-sm-6">
                        <div class="cardInput">
                            <div class="row">
                                professione
                            </div>
                            <div class="row">
                                <select type="select" class="inputForm" placeholder=" ">
                                    <!--@bind="gender"-->
                                    <option value="p">prova</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <div class="row">
                            <div class="col">
                                <div class="SmallcardInput">
                                    <div class="row">
                                        medico
                                    </div>
                                    <div class="row">
                                        <input class="inputForm" type="text"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="SmallcardInput">
                                    <div class="row">
                                        professione
                                    </div>
                                    <div class="row">
                                        <select type="select" class="inputForm" placeholder=" ">
                                            <!--@bind="gender"-->
                                            <option value="p">prova</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--quinta riga-->
                <div class="row mt-1">
                    <div class="cardInput textarea">
                        <div class="row">
                            indirizzi
                        </div>
                        <div class="row">
                            <textarea class="inputForm textarea"></textarea>
                        </div>
                    </div>
                </div>
                
            </div>
            
        </div>
        
        <!--parte tasti pc-->
        <div class="col-4 col-sm-2 SezPulsanti">
            <div class="row mt-1">
                <button class="formButton">
                    salva
                </button>
            </div>
            <div class="row mt-1">
                <button class="formButton">
                    salva e apri
                </button>
            </div>
            <div class="row mt-1">
                <button class="formButton">
                    salva e chiudi
                </button>
            </div>
            <div class="row mt-1">
                <button class="formButton">
                    annulla
                </button>
            </div>
            <div class="row mt-1">
                <button class="formButton">
                    stampa
                </button>
            </div>
            <div class="row mt-4">
                <button class="formButton importIcon">
                    importa CLiente
                </button>
            </div>
        </div>
        
        <!--sezione in bassso-->
        <div class="bottomForm mt-1">
            <div class="row" style="font-weight: bold; text-transform: uppercase;">
                <div class="col">preferenze</div>
            </div>
            <div class="row mt-1">
                <div class="col">
                    <button class="formButton">
                        motivo
                    </button>
                </div>
                <div class="col">
                    <button class="formButton">
                        nominativo
                    </button>
                </div>
                <div class="col">
                    <button class="formButton">
                        note
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
}

@code {
    private bool visible = false;

    private void toggleForm()
    {
        visible = !visible;
    }
    /*
    private string filePath;

    string searchValue = string.Empty;


    Paziente nuovoPaziente = new();
    List<Paziente> pazienti = new();
    List<Paziente> pazientiFiltrati = new();

    string gender = null!;
    private bool showFormErr = false;
    Paziente lastClickedP = null;

    protected override void OnInitialized()
    {
        getAllFromDB();
    }
    */

    /*
    private void getAllFromDB()
    {
        DbManager db = new DbManager();
        string query = "SELECT * FROM PATIENT";

        try
        {
            using (MySqlDataReader reader = db.ExecuteReader(query))
            {
                while (reader.Read())
                {
                    Paziente paziente = new Paziente().getFromDBReader(reader);
                    pazienti.Add(paziente);

                }
            }
        }
        catch (Exception e)
        {
            Console.WriteLine("Errore durante il recupero dei pazienti: " + e.Message);
            throw;
        }

        pazientiFiltrati = pazienti;
        db.CloseConnection();
    }

    private void searchPatient(ChangeEventArgs e)
    {

        searchValue = e.Value.ToString();
        var searchTerms = searchValue.Split(' ', StringSplitOptions.RemoveEmptyEntries);

        pazientiFiltrati = pazienti.Where(p =>
            searchTerms.All(term =>
                p.FirstName.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                p.Surname.Contains(term, StringComparison.OrdinalIgnoreCase)
            )
        ).ToList();
    }

    public void salvaPaziente()
    {
        nuovoPaziente.Gender = (gender == "m" ? false : true);
        if (checkInputs())
        {
            //salva il paziente
            Paziente paziente = new Paziente(nuovoPaziente.FirstName, nuovoPaziente.Surname, (gender == "m" ? false : true), "0000000000", "0000000000", "0000000000", "0000000000000000", "0000", nuovoPaziente.BirthDate, "Prova", nuovoPaziente.Foreigner, "Prova", "Prova", false, false, 1, nuovoPaziente.Locked);

            pazienti.Add(paziente);

            paziente.SaveInDB();

            pazientiFiltrati = pazienti;

            //se è visibile lo tolgo
            if (showFormErr) showFormErr = !showFormErr;
            toggleForm();
        }
        else
        {
            //mostro l'errore
            showFormErr = !showFormErr;
        }
    }

    public bool checkInputs()
    {
        return true;
    }

    public void updateLastClicked(Paziente p)
    {
        lastClickedP = p;
    }

    public void deleteFromDB()
    {
        if (lastClickedP!=null)
        {
            string query = $"DELETE FROM PATIENT WHERE patientID=" + lastClickedP.PatientID;
            DbManager db = new DbManager();
            db.MakeQuery(query);
            pazienti.Remove(lastClickedP);
            lastClickedP = null;
            pazientiFiltrati = pazienti;
        }
    }
    */
}