@page "/Anagrafica"
<PageTitle>Anagrafica</PageTitle>
@rendermode InteractiveServer
<div class="corpo">
    <div class="toolbar">
        <div class="slideContainer">
            <button class="slideSelez">PAZIENTI</button>
            <button class="slide">CLIENTI</button>
            <button class="slide">FORNITORI</button>
            <button class="slide">CONTATTI</button>
        </div>
        <div class="buttonContainer">
            <button class="defButton" @onclick="@toggleForm">AGGIUNGI</button>
            <button class="defButton">MODIFICA</button>
            <button class="defButton">ELIMINA</button>
            <button class="defButtonSmall">STAMPA</button>
            <input type="text" placeholder="Ricerca" @bind-value="searchQuery" @oninput="CercaPersona" class="inputSmall"/>
            <div class="insNumero">
                <div class="side">N</div>
                <input type="number" class="number"/>
            </div>
            <div class="insNumero">
                <div class="side">P</div>
                <input type="number" class="number"/>
            </div>
            <input type="text" placeholder="Avanzata" class="inputLarge"/>
        </div>
    </div>

    <div class="list">
        <table class="tabella">
            <thead>
            <tr class="headTable">
                <th>Cognome</th>
                <th>Nome</th>
                <th>Data di Nascita</th>
                <th>Sesso</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var persona in personeFiltrate)
            {
            <tr>
                <td>@persona.Cognome</td>
                <td>@persona.Nome</td>
                <td>@persona.DataNascita.ToString("dd/MM/yyyy")</td>
                <td>@persona.Sesso</td>
            </tr>
            }
            </tbody>
        </table>

    </div>
</div>


@if (visible)
{   
    <div class="oscuramento">
        <!-- div contenente il pop-up per l'inserimento dei dati -->
        <div class="Inserimento">
            <!-- div contenente la barra superiore -->
            <div>
                <div class="inline buttonFormContainer">
                    <button class="buttonFormSelected">DATI PERSONALI</button>
                    <button class="buttonForm">FAMILIARI</button>
                    <button class="buttonForm">CONTATTI - FATTURAZIONE</button>
                    <button class="buttonForm">NOTE</button>
                </div>
                <div class="inline">
                    <button @onclick="@toggleForm" class="exitButton">X</button>
                </div>
            </div>
            <div class="containerForm">
                <div class="forms">
                <!-- div colonna a sinistra -->
                <div class=" sx" >
                    <!-- div contenente i form principali -->
                    <div>
                        <div class="inline containerInput">
                            COGNOME*<br/>
                            <input type="text" @bind="nuovaPersona.Cognome" class="inputForm" placeholder="Poretti"/>
                        </div>
                        <div class="inline containerInput">
                            NOME*<br/>
                            <input type="text" @bind="nuovaPersona.Nome" class="inputForm" placeholder="Giacomo"/>
                        </div><br/>
                        <div class="inline containerInput">
                            <div>LUOGO DI NASCITA <div class="inline checkbox">estero<input type="checkbox"></div></div>
                            <input type="text" class="inputForm" placeholder="Giacomo"/>
                        </div>
                        <div class="inline containerInputSmall">
                            PROVINCIA<br/>
                            <input type="text" class="inputForm" placeholder="Milano"/>
                        </div>
                        <div class="inline containerInputSmall">
                            SESSO<br/>
                            <select type="select"  @bind="nuovaPersona.Sesso" class="inputFormScleta"placeholder=" ">
                                <option value="m">Maschio</option>
                                <option value="f">Femmina</option>
                            </select>
                        </div><br/>
                        <div class="inline containerInputSmall">
                            DATA NASCITA<br/>
                            <input type="date"  @bind="nuovaPersona.DataNascita" class="inputFormData"/>
                        </div>
                        <div class="inline containerInputSmall">
                            CODICE ASL<br/>
                            <input type="text" class="inputForm"placeholder="MI333"/>
                        </div>
                        <div class="inline containerInput">
                            <div>CODICE FISCALE <div class="inline checkbox"> cont. validit√†<input type="checkbox"></div></div>
                            <input type="text" class="inputForm" placeholder="PRTGCM64H07F205D"/>
                        </div><br/>
                        <div class="inline containerInputSmall">
                            CATEGORIA<br/>
                            <select type="select" class="inputFormScleta" placeholder=" ">
                                <option value="p">Prova</option>
                            </select>
                        </div>
                        <div class="inline containerInputSmall">
                            MEDICO<br/>
                            <input type="text" class="inputForm" placeholder="Ippocrate"/>
                        </div>
                        <div class="inline containerInput">
                            PROFESSIONE<br/>
                            <select type="select"  class="inputFormScleta"placeholder=" ">
                                <option value="p">Prova</option>
                            </select>
                        </div><br/>
                        <div class="inline containerInputLarge">
                            INDIRIZZI<br/>
                            <input type="text" class="inputFormLarge"placeholder="Via ..."/>
                        </div>
                    </div>
                    
                </div><!-- div contenente le referenze -->
                <br/>
                <div class="sx">
                    REFERENZE<br/>
                    <div class="inline pulsanti">
                        <button class="buttonOpzioniForm">MOTIVO</button>
                        <button class="buttonOpzioniForm">NOMINATIVO</button>
                        <button class="buttonOpzioniForm">NOTE</button>
                    </div>
                </div>
                </div>
                <!-- div colonna destra contenente i tasti di salvataggio ecc. -->
                <div class="dx">
                    <button class="buttonAzioniForm" @onclick="SalvaPersona">SALVA</button><br/>
                    <button class="buttonAzioniForm">SALVA E APRI</button><br/>
                    <button class="buttonAzioniForm">SALVA E CHIUDI</button><br/>
                    <button class="buttonAzioniForm">ANNULLA</button><br/>
                    <button class="buttonAzioniForm">STAMPA</button><br/>
                    <button class="buttonAzioniFormIcona">IMPORTA CLIENTE</button>
                </div>
            </div>
            </div>
            
    </div>
    
}

@code {
    public class Persona
    {
        public string Nome { get; set; }
        public string Cognome { get; set; }
        public DateTime DataNascita { get; set; }
        public string Sesso { get; set; }

        public override string ToString()
        {
            return $"{Nome};{Cognome};{DataNascita:dd/MM/yyyy};{Sesso}";
        }

        public static Persona FromString(string linea)
        {
            var dati = linea.Split(';');
            return new Persona
            {
                Nome = dati[0],
                Cognome = dati[1],
                DataNascita = DateTime.ParseExact(dati[2], "dd/MM/yyyy", null),
                Sesso = dati[3]
            };
        }
    }

    private bool visible = false;
    private Persona nuovaPersona = new Persona();
    private List<Persona> persone = new List<Persona>();
    private List<Persona> personeFiltrate = new List<Persona>();
    private string filePath;
    private string searchQuery = string.Empty;

    protected override void OnInitialized()
    {
        filePath = Path.Combine(Environment.CurrentDirectory, "wwwroot", "file.txt");
        CaricaPersone();
    }

    private void toggleForm()
    {
        visible = !visible;
    }

    private void SalvaPersona()
    {
        using (StreamWriter sw = new StreamWriter(filePath, true))
        {
            sw.WriteLine(nuovaPersona.ToString());
        }
        CaricaPersone();
        toggleForm();
    }

    private void CaricaPersone()
    {
        persone.Clear();
        personeFiltrate.Clear();
        if (File.Exists(filePath))
        {
            string[] lines = File.ReadAllLines(filePath);
            foreach (var line in lines)
            {
                if (!string.IsNullOrWhiteSpace(line))
                {
                    var persona = Persona.FromString(line);
                    persone.Add(persona);
                    personeFiltrate.Add(persona);
                }
            }
        }
    }

    private void CercaPersona(ChangeEventArgs e)
    {
        searchQuery = e.Value.ToString();
        var searchTerms = searchQuery.Split(' ', StringSplitOptions.RemoveEmptyEntries);

        personeFiltrate = persone.Where(p =>
            searchTerms.All(term => 
                p.Nome.Contains(term, StringComparison.OrdinalIgnoreCase) || 
                p.Cognome.Contains(term, StringComparison.OrdinalIgnoreCase)
            )
        ).ToList();
    }
}